#!/bin/sh

calc_tempdir() {
    prefix="${1:-filter-branch}"
    tempdir=$(
        mktemp -d /dev/shm/"$prefix".XXXXX ||
        mktemp -d /tmp/"$prefix".XXXXX ||
        echo ".git-rewrite"
    )

    rm -rf "$tempdir"

    echo "using $tempdir as temporary directory" >&2
    echo "$tempdir"
}
# delete git-filter-branch backup refs.
delete_fb_backups() {
    git for-each-ref --format="%(refname)" ${1:-refs/original/} | \
    xargs --no-run-if-empty -n 1 git update-ref -d
}

# some commits for a branch contain only the changed files in that commit
# This makes the git revision appear as deleting all the rest of the tree.
# Here we filter all revisions in the branch
# to contain the rest of the files, taken from the master revision right before branching.
# this code initially copied from kdegraphics/okular, but did not work for me.
# I had to replace master.. by ${prevmaster}..
# If a branch does not exist or does not need to be rewritten, continue.
# TODO: speed up by doing all fill_from within one git filter-branch

fill_from() {
	mastercommit=$1
	shift
	echo fill_from $mastercommit into $*
	prevmaster=$(echo $mastercommit | $bindir/translateRevlist.py)
	for branch in $*
	do
		( git branch -a ; git tag ) | grep -q $branch
		test $? -eq 0 || continue # branch does not exist
		tempdir="$(calc_tempdir $REPO-filter)"
		range="${prevmaster}..${branch}"
		echo fill_from $mastercommit into $branch
		git filter-branch -f -d "$tempdir" \
			--tree-filter "git read-tree $prevmaster" \
			--tag-name-filter cat \
			$range || continue
	done
}

# add a tag to every commit, name=svn revision
# ignores empty tagging commits (those removed by fix-tags)
# this helps much with visual debugging with gitk --all. Note
# however that gitk --all might then not show all branches for
# a commit for whatever reason.
add_revision_tags() {
	branches=$(git branch -a | grep -v HEAD | sed 's/ //g' | sed 's/^*//')
	git log --pretty=%h $branches | sort | uniq | while read commit
	do
		revision=r$(git show --pretty='%b' $commit | grep 'svn path=' | sed 's/.*revision=//')
		# a revision can appear more than once if it changes several branches
		test -r refs/tags/$revision && revision=X${revision}
		test -r refs/tags/$revision && revision=X${revision}
		test -r refs/tags/$revision && revision=X${revision}
		git tag $revision $commit
	done
}

#  From kooka-postprocess.sh:
#  Fix up branch commits created by cvs2svn, originally these have the
#  author 'nobody@localhost' which is not accepted by git.kde.org.
#  Replace them with a dummy name/email.
#
#  Need to do this on for all branches and with a null filter for tags,
#  so that the structure is preserved.  See man page for git-filter-branch(1):
#  "The rewritten history will have different object names for all the
#  objects and will not converge with the original branch".

# NOTE: it only compares mail address, please check if it also
# changes other commits which are not from cvs2svn

change_cvs2svn_author() {
	#  From http://help.github.com/changing-author-info/
	git filter-branch --env-filter '
		an="$GIT_AUTHOR_NAME"
		am="$GIT_AUTHOR_EMAIL"
		cn="$GIT_COMMITTER_NAME"
		cm="$GIT_COMMITTER_EMAIL"

		if expr "$GIT_COMMITTER_EMAIL" : "^nobody@" >/dev/null
		then
			cn="CVS2SVN"
			cm="cvs2svn@kde.org"
		fi
		if expr "$GIT_AUTHOR_EMAIL" : "^nobody@" >/dev/null
		then
			an="CVS2SVN"
			am="cvs2svn@kde.org"
		fi

		export GIT_AUTHOR_NAME="$an"
		export GIT_AUTHOR_EMAIL="$am"
		export GIT_COMMITTER_NAME="$cn"
		export GIT_COMMITTER_EMAIL="$cm"
		' --tag-name-filter "cat" -- --all
}
